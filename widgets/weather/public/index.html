<html>

<head>
	<style>
		textarea {
			background-color: transparent;
			resize: none;
			border-color: Transparent;
			color: var(--homey-text-color);
			font-size: var(--homey-font-size-default);
			overflow: hidden;
			width: auto;
			height: auto;
			white-space: nowrap;
		}

		textarea:focus {
			outline: none;
		}

		textarea#day0,
		textarea#wind0,
		textarea#sunrise_set,
		textarea#moonrise_set {
			position: absolute;
			left: 2%;
			height: auto;
		}

		textarea#day0 {
			top: 4%;
			width: 50%;
			font-size: var(--homey-font-size-xxlarge);
		}

		textarea#wind0 {
			top: 20%;
			width: 50%;
		}

		textarea#sunrise_set {
			top: 28%;
			width: 60%;
		}

		textarea#moonrise_set {
			top: 36%;
			width: 60%;
		}

		textarea#highTemp0,
		textarea#lowTemp0,
		textarea#cloud0,
		textarea#rain0 {
			position: absolute;
			left: 75%;
			width: 22%;
			height: auto;
		}

		textarea#highTemp0 {
			top: 4%;
		}

		textarea#lowTemp0 {
			top: 12%;
		}

		textarea#cloud0 {
			top: 28%;
		}

		textarea#rain0 {
			top: 35%;
		}

		img#Icon0 {
			position: absolute;
			left: 65%;
			top: 6%;
			transform: translateX(-50%);
			width: 20%;
			height: auto;
		}

		table {
			position: absolute;
			top: 48%;
			left: 5%;
			width: 90%;
			border-collapse: separate;
			border: none;
			background-color: transparent;
			color: var(--homey-text-color);
			font-size: var(--homey-font-size-default);
			max-height: calc(100% - 48%);
			overflow: auto;
			display: block;
			border-spacing: 5px;
			table-layout: auto;
			/* Changed from fixed to auto */
		}

		thead,
		tbody {
			display: block;
			overflow: hidden;
		}

		tbody {
			overflow-y: auto;
			max-height: calc(100% - 48%);
		}

		table img {
			width: 50%;
			height: auto;
		}

		table td,
		table th {
			width: 25%;
			max-width: none;
			/* Remove max-width restriction */
			min-width: 10%;
			/* Set a reasonable minimum width */
			text-align: center;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			/* Ensure text truncates if necessary */
			font-size: calc(10px + 1vw);
			/* Adjust font size for better fit */
		}

		table td img {
			display: block;
			margin: 0 auto;
		}

		table td:first-child,
		table th:first-child {
			width: 30px;
			min-width: 30px;
			max-width: 45px;
			overflow: hidden;
			word-wrap: break-word;
		}

		.separator-line {
			position: absolute;
			top: 47%;
			left: 10px;
			width: 90%;
			height: 1px;
			background-color: rgba(0, 0, 0, 0.2);
		}

		body {
			background: linear-gradient(180deg, rgb(0, 130, 250) 0%, rgba(192, 244, 247, 1) 52%, rgba(236, 242, 244, 1) 60%, rgba(236, 242, 244, 1) 100%);
			transition: background 1s ease;
			font-size: calc(12px + 0.5vw);
		}

		/* Dark Mode */
		.homey-dark-mode body {
			background: linear-gradient(180deg, rgb(25, 25, 112) 0%, rgb(59, 61, 74) 50%, rgb(31, 40, 41) 100%);
		}

		/* Responsive adjustments */
		@media (min-width: 400px) {
			textarea#day0 {
				left: 10%;
				width: 55%;
			}

			img#Icon0 {
				left: 65%;
				width: 15%;
			}

			textarea#highTemp0,
			textarea#lowTemp0,
			textarea#cloud0,
			textarea#rain0 {
				left: 75%;
				width: 25%;
			}

			table {
				left: 5%;
				width: 90%;
			}

			table td,
			table th {
				width: 25%;
				font-size: calc(10px + 1.6vw);
			}
		}
	</style>
</head>

<body class="homey-widget-small">
	<textarea id="day0" readonly>Sunday</textarea>
	<img id="Icon0" src="wsymbol_0001_sunny.png">
	<textarea id="highTemp0" readonly>🌡↑ 22°</textarea>
	<textarea id="lowTemp0" readonly>🌡↓ -2°</textarea>
	<textarea id="wind0" readonly>💨 SSW 5mph</textarea>
	<textarea id="sunrise_set" readonly>🔆 05:55AM - 06:34PM</textarea>
	<textarea id="moonrise_set" readonly>🌙 06:33PM - 04:20AM</textarea>
	<textarea id="cloud0">🌥️ 35%</textarea>
	<textarea id="rain0">☂️ 35%</textarea>
	<div class="separator-line"></div>
	<table>
		<tbody>
			<tr>
				<td></td>
				<td id="day1">Mon</td>
				<td id="day2">Tu</td>
				<td id="day3">Wed</td>
				<td id="day4">Thu</td>
			</tr>
			<tr>
				<td>🔆</td>
				<td>
					<img id="dayIcon1" src="">
				</td>
				<td>
					<img id="dayIcon2" src="">
				</td>
				<td>
					<img id="dayIcon3" src="">
				</td>
				<td>
					<img id="dayIcon4" src="">
				</td>
			</tr>
			<tr>
				<td>🌡↑</td>
				<td id="highTemp1">22°</td>
				<td id="highTemp2">22°</td>
				<td id="highTemp3">22°</td>
				<td id="highTemp4">22°</td>
			</tr>
			<tr>
				<td>☂️</td>
				<td id="dayRain1">35%</td>
				<td id="dayRain2">35%</td>
				<td id="dayRain3">35%</td>
				<td id="dayRain4">35%</td>
			</tr>
			<tr>
				<td>🌙</td>
				<td>
					<img id="nightIcon1" src="">
				</td>
				<td>
					<img id="nightIcon2" src="">
				</td>
				<td>
					<img id="nightIcon3" src="">
				</td>
				<td>
					<img id="nightIcon4" src="">
				</td>
			</tr>
			<tr>
				<td>🌡↓</td>
				<td id="lowTemp1">-2°</td>
				<td id="lowTemp2">-2°</td>
				<td id="lowTemp3">-2°</td>
				<td id="lowTemp4">-2°</td>
			</tr>
			<tr>
				<td>☂️</td>
				<td id="nightRain1">35%</td>
				<td id="nightRain2">35%</td>
				<td id="nightRain3">35%</td>
				<td id="nightRain4">35%</td>
			</tr>
		</tbody>
	</table>

	<script type="text/javascript">
		var_Homey = null;
		function onHomeyReady(Homey)
		{
			_Homey = Homey;
			Homey.ready();

			const settings = Homey.getSettings();
			const height = settings.height || 390;
			Homey.setHeight(height);

			Homey.api('GET', `/?deviceId=${settings.devices.id}`, {})
				.then((result) =>
				{
					updateWidget(result, settings);
				})
				.catch(console.error);

			Homey.on('updateWidget', function (deviceId)
			{
				const settings = Homey.getSettings();
				if (settings.devices.id !== deviceId)
				{
					return;
				}

				Homey.api('GET', `/?deviceId=${settings.devices.id}`, {})
					.then((result) =>
					{
						updateWidget(result, settings);
					})
					.catch(console.error);
			});
		}

		function adjustFontSize(textarea)
		{
			const maxFontSize = parseFloat(getComputedStyle(textarea).fontSize);
			let fontSize = maxFontSize;
			while ((textarea.scrollHeight > textarea.clientHeight || textarea.scrollWidth > textarea.clientWidth) && fontSize > 10)
			{
				fontSize -= 1;
				textarea.style.fontSize = `${fontSize}px`;
			}
		}

		function updateWidget(result, settings)
		{
			if (!result)
			{
				return;
			}

			// update todays elements
			const day = result[0];
			document.getElementById(`day0`).value = day.day;
			document.getElementById(`Icon0`).src = day.dayIcon ? day.dayIcon : day.nightIcon; // Updated to use dayIcon
			document.getElementById(`highTemp0`).value = day.highTemp ? `🌡↑${day.highTemp}°` : "";
			document.getElementById(`lowTemp0`).value = `🌡↓${day.lowTemp}°`; // Updated to use thermometer symbol
			document.getElementById(`wind0`).value = day.dayGustStrength ? `💨 ${day.dayWindAngle} ${day.dayGustStrength}${day.windSpeedUnits}` : `💨 ${day.nightWindAngle} ${day.nightGustStrength}${day.windSpeedUnits}`; // Updated to use dayGustStrength
			document.getElementById(`cloud0`).value = day.dayCloud ? `☁️ ${day.dayCloud}%` : `☁️ ${day.nightCloud}%`; // Updated to use dayCloud
			document.getElementById(`rain0`).value = day.dayRain ? `☂️ ${day.dayRain}%` : `☂️ ${day.nightRain}%`; // Updated rain percentage

			// Convert the sunrise and sunset times based on time format
			const formatTime = (date, is24Hour) =>
			{
				const hours = String(date.getHours()).padStart(2, '0'); // Add leading zero
				const minutes = String(date.getMinutes()).padStart(2, '0');
				if (is24Hour)
				{
					return `${hours}:${minutes}`;
				} else
				{
					const hours12 = hours % 12 || 12;
					const amPm = hours < 12 ? 'AM' : 'PM';
					return `${hours12}:${minutes}${amPm}`;
				}
			};

			const is24Hour = settings.timeFormat === '24';
			const sunrise = new Date(day.sunrise);
			const sunset = new Date(day.sunset);
			const moonrise = new Date(day.moonrise);
			const moonset = new Date(day.moonset);

			const sunriseTime = formatTime(sunrise, is24Hour);
			const sunsetTime = formatTime(sunset, is24Hour);
			const moonriseTime = formatTime(moonrise, is24Hour);
			const moonsetTime = formatTime(moonset, is24Hour);

			document.getElementById(`sunrise_set`).innerText = `🔆 ${sunriseTime} - ${sunsetTime}`;
			document.getElementById(`moonrise_set`).innerText = `🌙 ${moonriseTime} - ${moonsetTime}`;

			// update the table elements
			for (let i = 1; i < 5; i++)
			{
				const day = result[i];

				// Just use the first 3 characters of the day name
				const dayName = day.day.length > 3 ? day.day.substring(0, 3) : day.day;
				document.getElementById(`day${i}`).innerText = dayName;

				document.getElementById(`highTemp${i}`).innerText = `${day.highTemp}°`;
				document.getElementById(`lowTemp${i}`).innerText = `${day.lowTemp}°`;
				document.getElementById(`dayRain${i}`).innerText = `${day.dayRain}%`; // Updated rain percentage for day
				document.getElementById(`nightRain${i}`).innerText = `${day.nightRain}%`; // Updated rain percentage for night

				// update the icons
				document.getElementById(`dayIcon${i}`).src = day.dayIcon;
				document.getElementById(`nightIcon${i}`).src = day.nightIcon; // Updated to use nightIcon
			}

			// Adjust font size for all textareas
			const textareas = document.querySelectorAll('textarea');
			textareas.forEach(adjustFontSize);
		}

		// Adjust font size on window resize
		window.addEventListener('resize', () =>
		{
			const textareas = document.querySelectorAll('textarea');
			textareas.forEach(adjustFontSize);
		});
	</script>
</body>

</html>